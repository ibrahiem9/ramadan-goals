<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Ramadan Goals</title>
    <meta
      name="description"
      content="Ramadan Goals - a mobile-first app for daily goal tracking and progress."
    >
    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        min-height: 100%;
        background: #0c1222;
        color: #fff;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      }

      #root {
        min-height: 100vh;
      }

      .boot-error {
        max-width: 720px;
        margin: 2rem auto;
        padding: 1rem 1.25rem;
        border-radius: 10px;
        border: 1px solid rgba(239, 68, 68, 0.4);
        background: rgba(239, 68, 68, 0.08);
        line-height: 1.5;
      }
    </style>
    <script src="https://unpkg.com/@babel/standalone@7.26.2/babel.min.js"></script>
    <script>
      // Configure these values for production deployments (e.g. Netlify script injection).
      window.__APP_CONFIG__ = window.__APP_CONFIG__ || {
        SUPABASE_URL: "https://fiozgcscdokqewimkkkq.supabase.co",
        SUPABASE_ANON_KEY: "sb_publishable_3XaN_cZvUE-QDfPapvQUOw_YnoH2QMK",
        RAMADAN_DEFAULT_CITY: "",
        RAMADAN_DEFAULT_COUNTRY: "",
        ALADHAN_BASE_URL: "https://api.aladhan.com/v1"
      };
    </script>
    <script type="importmap">
      {
        "imports": {
          "react": "https://esm.sh/react@18.3.1",
          "react-dom/client": "https://esm.sh/react-dom@18.3.1/client",
          "react/jsx-runtime": "https://esm.sh/react@18.3.1/jsx-runtime",
          "@supabase/supabase-js": "https://esm.sh/@supabase/supabase-js@2.49.4"
        }
      }
    </script>
  </head>
  <body>
    <div id="root"></div>
    <noscript>This app requires JavaScript to run.</noscript>
    <script type="module">
      const rootEl = document.getElementById("root");

      // Polyfill storage API for local/browser hosting environments.
      if (!window.storage) {
        window.storage = {
          async get(key) {
            const value = localStorage.getItem(key);
            return value === null ? null : { value };
          },
          async set(key, value) {
            localStorage.setItem(key, value);
          },
          async removeItem(key) {
            localStorage.removeItem(key);
          }
        };
      }

      // Rewrite absolute /src/* imports so blob-based module loading resolves via HTTP(S).
      function getSrcBaseUrl() {
        return new URL("./src/", window.location.href).href;
      }

      function rewriteSrcImportSpecifiers(source, srcBaseUrl) {
        const toAbsoluteSrcUrl = (path) => `${srcBaseUrl}${path}`;
        return source
          .replace(
            /(from\s+)(['"])\/src\/([^'"]+)\2/g,
            (_, prefix, quote, path) => `${prefix}${quote}${toAbsoluteSrcUrl(path)}${quote}`
          )
          .replace(
            /(import\s*\(\s*)(['"])\/src\/([^'"]+)\2(\s*\))/g,
            (_, prefix, quote, path, suffix) => `${prefix}${quote}${toAbsoluteSrcUrl(path)}${quote}${suffix}`
          );
      }

      async function bootstrap() {
        const [{ default: React }, { createRoot }] = await Promise.all([
          import("react"),
          import("react-dom/client")
        ]);

        const sourceResp = await fetch("./main.jsx", { cache: "no-store" });
        if (!sourceResp.ok) {
          throw new Error(`Unable to load main.jsx (${sourceResp.status})`);
        }

        const source = await sourceResp.text();
        const srcBaseUrl = getSrcBaseUrl();
        const rewrittenSource = rewriteSrcImportSpecifiers(source, srcBaseUrl);
        const transformed = Babel.transform(rewrittenSource, {
          filename: "main.jsx",
          sourceType: "module",
          presets: [["react", { runtime: "automatic" }]]
        }).code;

        const moduleBlob = new Blob([transformed], { type: "text/javascript" });
        const moduleUrl = URL.createObjectURL(moduleBlob);

        try {
          const mod = await import(moduleUrl);
          const App = mod.default;
          createRoot(rootEl).render(React.createElement(App));
        } finally {
          URL.revokeObjectURL(moduleUrl);
        }
      }

      bootstrap().catch((error) => {
        const message = error instanceof Error ? error.message : String(error);
        const isModuleSpecifierError = message.includes("Failed to resolve module specifier");
        const failureType = isModuleSpecifierError
          ? "module-specifier-resolution"
          : "transform-or-runtime";

        console.error("Failed to bootstrap app:", error);
        console.info(`Bootstrap failure type: ${failureType}`);
        if (isModuleSpecifierError) {
          console.info(
            "Bootstrap hint: /src/* imports must resolve to HTTP(S) URLs when main.jsx is imported from a blob URL."
          );
        }

        const primaryHint = isModuleSpecifierError
          ? "Bootstrap could not resolve app module paths. Hard-refresh and verify deployed src/* assets return 200."
          : "The app hit a startup error while transforming or importing main.jsx.";
        rootEl.innerHTML = `
          <div class="boot-error">
            <strong>App failed to start.</strong><br>
            ${primaryHint}<br>
            Note: ERR_BLOCKED_BY_CLIENT for Bugsnag/Segment is usually extension blocking and often non-fatal.<br>
            Check browser console for details.
          </div>
        `;
      });
    </script>
  </body>
</html>
